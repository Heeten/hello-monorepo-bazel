<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Building Rust protobuf - Using Bazel with Rust, gRPC, protobuf, and Docker</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="02_pre_reqs_install_bazel.html"><strong aria-hidden="true">2.</strong> Prerequisites and Installing Bazel</a></li><li class="chapter-item expanded "><a href="03a_create_repo_workspace.html"><strong aria-hidden="true">3.</strong> Create repository and bazel workspace</a></li><li class="chapter-item expanded "><a href="03b_rust_hello_world.html"><strong aria-hidden="true">4.</strong> Rust hello world</a></li><li class="chapter-item expanded "><a href="03c_rust_lib_unit_test.html"><strong aria-hidden="true">5.</strong> Rust Library</a></li><li class="chapter-item expanded "><a href="03d_rust_unit_test.html"><strong aria-hidden="true">6.</strong> Unit test Rust Library</a></li><li class="chapter-item expanded "><a href="03e_rust_linked_binary.html"><strong aria-hidden="true">7.</strong> Link rust binary to library</a></li><li class="chapter-item expanded "><a href="release_mode.html"><strong aria-hidden="true">8.</strong> '--release mode' builds</a></li><li class="chapter-item expanded "><a href="05_rust_cli_client_with_clap.html"><strong aria-hidden="true">9.</strong> Pulling in external crates like Clap</a></li><li class="chapter-item expanded "><a href="rust_protobuf.html" class="active"><strong aria-hidden="true">10.</strong> Building Rust protobuf</a></li><li class="chapter-item expanded "><a href="04_rust_grpc_server_and_third_party_crates.html"><strong aria-hidden="true">11.</strong> Rust gRPC Server</a></li><li class="chapter-item expanded "><a href="06_docker_container.html"><strong aria-hidden="true">12.</strong> Docker Container</a></li><li class="chapter-item expanded "><a href="07_cloud_run.html"><strong aria-hidden="true">13.</strong> Pushing containers and running on Google Cloud</a></li><li class="chapter-item expanded "><a href="conclusion.html"><strong aria-hidden="true">14.</strong> Conclusion</a></li><li class="chapter-item expanded "><a href="teardown.html"><strong aria-hidden="true">15.</strong> PS: Tearing down</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Using Bazel with Rust, gRPC, protobuf, and Docker</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="building-rust-protobuf"><a class="header" href="#building-rust-protobuf">Building Rust protobuf</a></h1>
<p>Generating code for protobufs in rust is a lot more complicated than other languages. We'll cover how to do both.</p>
<p>We'll start with other language support since that includes pulling down the protoc compiler which we'll also
need for rust.</p>
<h2 id="creating-the-protofile"><a class="header" href="#creating-the-protofile">Creating the protofile</a></h2>
<p>Lets decide where we want to put our protobuf file. Bazel doesn't care where we put it,
so I'm going to arbitarly pick <code>//src/proto/summation</code> as the path for it.</p>
<p>Let's put to protobuf file in <code>$HOME/repo/src/proto/summation/summation.proto</code> with these contents</p>
<pre><code>syntax = &quot;proto3&quot;;

package src_proto_summation;

service Summation {
  rpc ComputeSumF64(ComputeSumF64Request) returns (ComputeSumF64Response);
}

message ComputeSumF64Request {
  repeated double value = 1;
}

message ComputeSumF64Response {
  double sum = 1;
}
</code></pre>
<p>Our package name above is unconventional, we are using underscores instead of dots. This is to match
the crate naming convention we adopted for rust libraries.</p>
<h2 id="adding-rules_proto-for-protobuf-generation-in-protoc-supported-languages"><a class="header" href="#adding-rules_proto-for-protobuf-generation-in-protoc-supported-languages">Adding rules_proto for protobuf generation in protoc supported languages</a></h2>
<p>We're going to use the bazel rules from <a href="https://github.com/bazelbuild/rules_proto">rules_proto</a>.
Let's pull this down by adding this section to our <code>$HOME/repo/WORKSPACE</code> file:</p>
<pre><code class="language-python">### rules_proto
### Release info from https://github.com/bazelbuild/rules_proto/releases
http_archive(
    name = &quot;rules_proto&quot;,
    sha256 = &quot;dc3fb206a2cb3441b485eb1e423165b231235a1ea9b031b4433cf7bc1fa460dd&quot;,
    strip_prefix = &quot;rules_proto-5.3.0-21.7&quot;,
    urls = [
        &quot;https://github.com/bazelbuild/rules_proto/archive/refs/tags/5.3.0-21.7.tar.gz&quot;,
    ],
)
load(&quot;@rules_proto//proto:repositories.bzl&quot;, &quot;rules_proto_dependencies&quot;, &quot;rules_proto_toolchains&quot;)
rules_proto_dependencies()
rules_proto_toolchains()
</code></pre>
<p>Next lets make <code>$HOME/repo/src/proto/summation/BUILD</code>:</p>
<pre><code class="language-python">load(&quot;@rules_proto//proto:defs.bzl&quot;, &quot;proto_library&quot;)

proto_library(
    name = &quot;proto&quot;,
    srcs = [
        &quot;summation.proto&quot;,
    ],
    visibility = [&quot;//visibility:public&quot;],
)
</code></pre>
<p>Finally run <code>bazel build //...</code> to build everything.</p>
<h2 id="protobuf-generation-in-rust"><a class="header" href="#protobuf-generation-in-rust">Protobuf generation in Rust</a></h2>
<p>We're going to use <a href="https://github.com/hyperium/tonic">tonic</a> for our gRPC server and use tonic_build to generate the protobuf and gRPC code.</p>
<h3 id="pulling-in-tonic-tonic_build-and-prost"><a class="header" href="#pulling-in-tonic-tonic_build-and-prost">Pulling in tonic, tonic_build, and prost</a></h3>
<p>Do generate and compile the protobuf and gRPC code we'll need to explictly expose the tonic, tonic_build, and prost crates.</p>
<p>When we pull down tonic we'll enable the tls features, even though we won't use them (yet) in this guide. We'll also need
to tell bazel that the compile depends on <code>*.md</code> files for prost, and some other files for other transitive dependencies (which
we don't explictly pull down but it an implicit dependency pulled down).</p>
<p>So we'll add the following under <code>[dependencies]</code>:</p>
<pre><code class="language-toml">prost = &quot;0.11.6&quot;
tonic = { version = &quot;0.9.1&quot;, features = [&quot;tls&quot;, &quot;tls-roots&quot;, &quot;default&quot;] }
tonic-build = &quot;0.9.1&quot;
</code></pre>
<p>And these to the bottom of the file:</p>
<pre><code class="language-toml">[package.metadata.raze.crates.prost.'*']
compile_data_attr = &quot;glob([\&quot;**/*.md\&quot;])&quot;

[package.metadata.raze.crates.rustls-webpki.'*']
compile_data_attr = &quot;glob([\&quot;**/*.der\&quot;])&quot;

[package.metadata.raze.crates.ring.'*']
compile_data_attr = &quot;glob([\&quot;**/*.der\&quot;])&quot;

[package.metadata.raze.crates.axum.'*']
compile_data_attr = &quot;glob([\&quot;**/*.md\&quot;])&quot;
</code></pre>
<p>Our full <code>$HOME/repo/third_party/rust/Cargo.toml</code> will look like:</p>
<pre><code class="language-toml">[package]
name = &quot;compile_with_bazel&quot;
version = &quot;0.0.0&quot;

# Mandatory (or Cargo tooling is unhappy)
[lib]
path = &quot;fake_lib.rs&quot;

[dependencies]
clap = { version = &quot;4.2.2&quot;, features = [&quot;derive&quot;] }
log = &quot;0.4.17&quot;
prost = &quot;0.11.6&quot;
tonic = { version = &quot;0.9.1&quot;, features = [&quot;tls&quot;, &quot;tls-roots&quot;, &quot;default&quot;] }
tonic-build = &quot;0.9.1&quot;

[package.metadata.raze]
# The path at which to write output files.
#
# `cargo raze` will generate Bazel-compatible BUILD files into this path.
# This can either be a relative path (e.g. &quot;foo/bar&quot;), relative to this
# Cargo.toml file; or relative to the Bazel workspace root (e.g. &quot;//foo/bar&quot;).
workspace_path = &quot;//third_party/rust&quot;

# This causes aliases for dependencies to be rendered in the BUILD
# file located next to this `Cargo.toml` file.
package_aliases_dir = &quot;.&quot;

# The set of targets to generate BUILD rules for.
targets = [
    &quot;x86_64-unknown-linux-gnu&quot;,
]

# The two acceptable options are &quot;Remote&quot; and &quot;Vendored&quot; which
# is used to indicate whether the user is using a non-vendored or
# vendored set of dependencies.
genmode = &quot;Remote&quot;

default_gen_buildrs = true

[package.metadata.raze.crates.clap.'*']
compile_data_attr = &quot;glob([\&quot;**/*.md\&quot;])&quot;

[package.metadata.raze.crates.clap_builder.'*']
compile_data_attr = &quot;glob([\&quot;**/*.md\&quot;])&quot;

[package.metadata.raze.crates.clap_derive.'*']
compile_data_attr = &quot;glob([\&quot;**/*.md\&quot;])&quot;

[package.metadata.raze.crates.prost.'*']
compile_data_attr = &quot;glob([\&quot;**/*.md\&quot;])&quot;

[package.metadata.raze.crates.rustls-webpki.'*']
compile_data_attr = &quot;glob([\&quot;**/*.der\&quot;])&quot;

[package.metadata.raze.crates.ring.'*']
compile_data_attr = &quot;glob([\&quot;**/*.der\&quot;])&quot;

[package.metadata.raze.crates.axum.'*']
compile_data_attr = &quot;glob([\&quot;**/*.md\&quot;])&quot;
</code></pre>
<p>Now lets delete the lock file and run cargo raze:</p>
<pre><code class="language-shell">cd $HOME/repo/third_party/rust/
rm Cargo.raze.lock
cargo raze
</code></pre>
<p>And finally run <code>bazel build //...</code> to make sure we haven't broken anything yet.</p>
<h3 id="using-tonic-to-generate-protobuf-and-grpc-code"><a class="header" href="#using-tonic-to-generate-protobuf-and-grpc-code">Using tonic to generate protobuf and gRPC code</a></h3>
<p>To get a rust protobuf/gRPC library we need to run two steps. The first is running the
tonic_build generator, which we can think of as having a <code>build.rs</code> or cargo build script
that we run first. We'll use rules_rust [cargo_build_script] to do this.</p>
<p>First lets make the <code>$HOME/repo/src/proto/summation/build.rs</code>:</p>
<pre><pre class="playground"><code class="language-rust">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    tonic_build::compile_protos(&quot;./summation.proto&quot;)?;
    Ok(())
}</code></pre></pre>
<p>Next lets update <code>$HOME/repo/src/proto/summation/BUILD</code> to use it:</p>
<pre><code class="language-python">load(&quot;@rules_proto//proto:defs.bzl&quot;, &quot;proto_library&quot;)
load(&quot;@rules_rust//cargo:cargo_build_script.bzl&quot;, &quot;cargo_build_script&quot;)

proto_library(
    name = &quot;proto&quot;,
    srcs = [
        &quot;summation.proto&quot;,
    ],
    visibility = [&quot;//visibility:public&quot;],
)

cargo_build_script(
    name = &quot;generate_rust_proto&quot;,
    srcs = [
        &quot;build.rs&quot;,
    ],
    deps = [
        &quot;//third_party/rust:tonic_build&quot;,
    ],
    build_script_env = {
        &quot;RUSTFMT&quot;: &quot;$(execpath @rules_rust//:rustfmt)&quot;,
        &quot;PROTOC&quot;: &quot;$(execpath @com_google_protobuf//:protoc)&quot;
    },
    data = [
        &quot;summation.proto&quot;,
        &quot;@rules_rust//:rustfmt&quot;,
        &quot;@com_google_protobuf//:protoc&quot;,
    ],
)
</code></pre>
<p>We've added a load line for <code>cargo_build_script</code> and then invoked that rule to run the generator. There's a lot going on here. One thing to note is Bazel uses different attributes to convey different <a href="https://bazel.build/concepts/dependencies#types-of-dependencies">types of dependencies</a>. We've seen <code>srcs</code> and <code>deps</code> already, <code>data</code> is kind of a catch-all used when
things don't fit in <code>srcs</code> or <code>deps</code>. How these attributes are used varied based on the rule, so it's useful to check the
docs of the rule you're using.</p>
<p>In this case we're telling bazel that if the protofil, rustfmt, or protoc change we need to rerun the build script using the <code>data</code> attribute, and we're also telling it to expose those in the sandbox it runs the compile in.</p>
<p>When we run the build script, we also need to set the environment variables <code>RUSTFMT</code> and <code>PROTOC</code> so that tonic_build knows where to find those, which is what the <code>build_script_env</code> attribute does. The <code>@rules_rust</code> is us pointing to the
external <code>rules_rust</code> bazel workspace we're depending on in our <code>WORKSPACE</code> file. The <code>srcs</code> attribute points to our <code>build.rs</code> file (which we could have named something else like generate_rust_proto.rs if we wanted.</p>
<h3 id="exposing-in-a-rust-library"><a class="header" href="#exposing-in-a-rust-library">Exposing in a rust library</a></h3>
<p>The prior step just runs the build script. We need to add a <code>rust_library</code> target that includes it.</p>
<p>To do this we'll add this to <code>$HOME/repo/src/proto/summation/BUILD</code></p>
<pre><code class="language-python">load(&quot;@rules_rust//rust:defs.bzl&quot;, &quot;rust_library&quot;)

rust_library(
    name = &quot;src_proto_summation&quot;,
    srcs = [
        &quot;lib.rs&quot;,
    ],
    deps = [
        &quot;:generate_rust_proto&quot;,
        &quot;//third_party/rust:prost&quot;,
        &quot;//third_party/rust:tonic&quot;,
    ],
    visibility = [&quot;//visibility:public&quot;],
)
</code></pre>
<p>And we'll create <code>$HOME/repo/src/proto/summation/BUILD</code> with</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>tonic::include_proto!(&quot;src_proto_summation&quot;);
<span class="boring">}</span></code></pre></pre>
<p>Finally lets run <code>bazel build //...</code> and make sure everything builds!</p>
<p>There's a decent amount of boilerplate for creating the proto. If I was doing it a lot, I would make my own bazel rule
that does all this for me.</p>
<h3 id="examining-the-generated-rust-file"><a class="header" href="#examining-the-generated-rust-file">Examining the generated rust file</a></h3>
<p>Above we're generating the <code>src_proto_summation.rs</code> file. You can find the generated file in your $HOME/repo/bazel-out directory. The exact path will vary slightly, for me it's in <code>$HOME/repo/bazel-out/k8-fastbuild/bin/src/proto/summation/generate_rust_proto.out_dir/src_proto_summation.rs</code></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="05_rust_cli_client_with_clap.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="04_rust_grpc_server_and_third_party_crates.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="05_rust_cli_client_with_clap.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="04_rust_grpc_server_and_third_party_crates.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>


        <!-- Google Analytics Tag -->
        <script>
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'G-JJ892SZC4M', 'auto');
                ga('send', 'pageview');
            }
        </script>


        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
